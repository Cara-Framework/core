"""
Policy Generation Command for the Cara framework.
"""

from pathlib import Path

from cara.commands import CommandBase
from cara.decorators import command
from cara.support import paths


@command(
    name="make:policy",
    help="Generate a new Policy class with enhanced options.",
    options={
        "--dry": "Show what would be generated without creating files",
        "--force": "Overwrite existing policy file",
        "--model=?": "The model this policy should authorize",
    },
)
class MakePolicyCommand(CommandBase):
    """Generate Policy classes with enhanced configuration."""

    def handle(self, name: str, model: str = None):
        """Handle policy generation."""
        self.info("ðŸ—ï¸  Policy Generation")

        try:
            policy_info = self._prepare_policy_info(name, model)
        except ValueError as e:
            self.error(f"âŒ {e}")
            return

        if self._check_existing_file(policy_info):
            return

        if self.option("dry"):
            self._show_dry_run(policy_info)
            return

        try:
            self._generate_policy(policy_info)
        except Exception as e:
            self.error(f"âŒ Failed to generate policy: {e}")

    def _prepare_policy_info(self, name: str, model: str = None) -> dict:
        """Prepare policy information."""
        if not name:
            raise ValueError("Policy name is required")

        class_name = self._clean_class_name(name)
        policies_dir = Path(paths("policies"))
        file_path = policies_dir / f"{class_name}.py"

        return {
            "class_name": class_name,
            "model_name": model,
            "file_path": file_path,
            "policies_dir": policies_dir,
        }

    def _clean_class_name(self, name: str) -> str:
        """Clean and format class name."""
        if name.endswith(".py"):
            name = name[:-3]
        name = "".join(word.capitalize() for word in name.replace("_", " ").split())
        if not name.endswith("Policy"):
            name += "Policy"
        return name

    def _check_existing_file(self, policy_info: dict) -> bool:
        """Check if policy file already exists."""
        if policy_info["file_path"].exists() and not self.option("force"):
            self.warning(f"âš ï¸  Policy already exists: {policy_info['file_path']}")
            self.info("ðŸ’¡ Use --force to overwrite existing policy")
            return True
        return False

    def _show_dry_run(self, policy_info: dict) -> None:
        """Show dry run preview."""
        self.info("ðŸ” DRY RUN MODE - No files will be created")
        self.info("ðŸ“‹ Policy configuration:")
        self.info(f"   Class Name: {policy_info['class_name']}")
        self.info(f"   Model: {policy_info['model_name'] or 'Generic'}")
        self.info(f"   File Path: {policy_info['file_path']}")

    def _generate_policy(self, policy_info: dict) -> None:
        """Generate the policy file."""
        self.info("ðŸ”§ Configuration:")
        self.info(f"   Class: {policy_info['class_name']}")
        self.info(f"   Model: {policy_info['model_name'] or 'Generic'}")
        self.info(f"   File: {policy_info['file_path']}")

        policy_info["policies_dir"].mkdir(parents=True, exist_ok=True)
        code = self._generate_policy_code(policy_info)

        self.info("âš¡ Generating policy...")
        try:
            with open(policy_info["file_path"], "w", encoding="utf-8") as f:
                f.write(code)

            self.info("âœ… Policy created successfully!")
            self.info(f"ðŸ“ Location: {policy_info['file_path']}")
            self._show_usage_tips(policy_info)

        except Exception as e:
            raise Exception(f"Failed to write policy file: {e}")

    def _generate_policy_code(self, policy_info: dict) -> str:
        """Generate the policy class code."""
        stub_path = Path(paths("cara")) / "commands" / "stubs" / "Policy.stub"

        with open(stub_path, "r", encoding="utf-8") as f:
            stub_content = f.read()

        code = stub_content.replace("{{ class_name }}", policy_info["class_name"])
        code = code.replace(
            "{{ docstring }}",
            f"{policy_info['class_name']}\n\nGenerated by Cara framework make:policy command.",
        )

        return code

    def _show_usage_tips(self, policy_info: dict) -> None:
        """Show usage examples."""
        class_name = policy_info["class_name"]
        model_name = policy_info["model_name"]

        self.info("\nðŸ’¡ Usage Tips:")
        self.info(f"   Import: from app.policies import {class_name}")
        self.info("   Register policy in AuthServiceProvider:")
        if model_name:
            self.info(f"     Gate.policy({model_name}, {class_name})")
        else:
            self.info(f"     Gate.policy(YourModel, {class_name})")
        self.info("   Check authorization:")
        self.info("     user.can('update', model)")
        self.info("     Gate.allows('update', model)")
