"""
JobLog Generation Command for the Cara framework.

This module provides a CLI command to generate JobLog model for advanced job tracking.
"""

from pathlib import Path

from cara.commands import CommandBase
from cara.decorators import command
from cara.support import paths


@command(
    name="make:job-log",
    help="Generate a JobLog model for advanced job tracking",
    options={
        "--dry": "Show what would be generated without creating files",
        "--force": "Overwrite existing model file",
        "--table": "Specify table name (default: job_logs)",
    },
)
class MakeJobLogCommand(CommandBase):
    """Generate JobLog model for advanced job tracking."""

    def handle(self, name: str = "JobLog"):
        """Handle JobLog generation."""
        self.info("ðŸ—ï¸  JobLog Generation")

        # Validate and prepare
        try:
            joblog_info = self._prepare_joblog_info(name)
        except ValueError as e:
            self.error(f"âŒ {e}")
            return

        # Check if file exists
        if self._check_existing_file(joblog_info):
            return

        # Dry run mode
        if self.option("dry"):
            self._show_dry_run(joblog_info)
            return

        # Generate JobLog
        try:
            self._generate_joblog(joblog_info)
        except Exception as e:
            self.error(f"âŒ Failed to generate JobLog: {e}")
            raise

    def _prepare_joblog_info(self, name: str) -> dict:
        """Prepare JobLog generation information."""
        if not name:
            raise ValueError("JobLog name cannot be empty")

        # Clean name
        class_name = name.replace("JobLog", "").strip()
        if not class_name:
            class_name = "JobLog"
        else:
            class_name = (
                f"{class_name}JobLog"
                if not class_name.endswith("JobLog")
                else class_name
            )

        # Determine paths
        models_dir = Path(paths("app")) / "models"
        file_path = models_dir / f"{class_name}.py"

        # Table name
        table_name = self.option("table") or "job_logs"

        return {
            "class_name": class_name,
            "table_name": table_name,
            "models_dir": models_dir,
            "file_path": file_path,
        }

    def _check_existing_file(self, joblog_info: dict) -> bool:
        """Check if JobLog file already exists."""
        if joblog_info["file_path"].exists() and not self.option("force"):
            self.error(f"âŒ JobLog already exists: {joblog_info['file_path']}")
            self.info("ðŸ’¡ Use --force to overwrite or choose a different name")
            return True
        return False

    def _show_dry_run(self, joblog_info: dict) -> None:
        """Show what would be generated in dry run mode."""
        self.info("ðŸ” Dry Run - JobLog Generation Preview:")
        self.info(f"   Class: {joblog_info['class_name']}")
        self.info(f"   Table: {joblog_info['table_name']}")
        self.info(f"   File: {joblog_info['file_path']}")
        self.info("   Features: Job tracking, retry logic, analytics")

    def _generate_joblog(self, joblog_info: dict) -> None:
        """Generate the JobLog model."""
        # Create directory
        joblog_info["models_dir"].mkdir(parents=True, exist_ok=True)

        # Generate code
        code = self._generate_joblog_code(joblog_info)

        # Write file
        self.info("âš¡ Generating JobLog model...")

        try:
            with open(joblog_info["file_path"], "w", encoding="utf-8") as f:
                f.write(code)

            self.info("âœ… JobLog model created successfully!")
            self.info(f"ðŸ“ Location: {joblog_info['file_path']}")

            self._show_usage_tips(joblog_info)

        except Exception as e:
            raise Exception(f"Failed to write JobLog file: {e}")

    def _generate_joblog_code(self, joblog_info: dict) -> str:
        """Generate the JobLog model code using stub."""
        class_name = joblog_info["class_name"]
        table_name = joblog_info["table_name"]

        # Load stub file
        stub_path = Path(paths("cara")) / "commands" / "stubs" / "JobLog.stub"

        with open(stub_path, "r", encoding="utf-8") as f:
            stub_content = f.read()

        # Replace placeholders
        code = stub_content.replace("{{ class_name }}", class_name)
        code = code.replace("{{ table_name }}", table_name)
        code = code.replace(
            "{{ docstring }}",
            f"{class_name} Model for Advanced Job Tracking.\n\nGenerated by Cara framework make:job-log command.",
        )

        return code

    def _show_usage_tips(self, joblog_info: dict) -> None:
        """Show usage examples for the generated JobLog."""
        class_name = joblog_info["class_name"]

        self.info("\nðŸ’¡ Usage Tips:")
        self.info(f"   Import: from app.models import {class_name}, Job")
        self.info("")
        self.info("ðŸ“‹ Setup Steps:")
        self.info("1. Add to app/models/__init__.py:")
        self.info(f"   from .{class_name} import {class_name}")
        self.info(f"   __all__ = [..., '{class_name}']")
        self.info("")
        self.info("2. Register JobTracker in ApplicationProvider:")
        self.info("   def register_job_tracker(self):")
        self.info(f"       from app.models import Job, {class_name}")
        self.info("       from cara.queues.tracking import JobTracker")
        self.info("       self.application.singleton(")
        self.info('           "JobTracker",')
        self.info(
            f"           lambda: JobTracker(job_log_model={class_name}, job_model=Job)"
        )
        self.info("       )")
        self.info("")
        self.info("3. Run: python craft make:migration  # Auto-generate migration")
        self.info("4. Run: python craft migrate         # Create tables")
        self.info("")
        self.info("âœ… Jobs with Trackable trait will now:")
        self.info("   - Auto-track to job + job_logs tables")
        self.info("   - Handle conflicts (prevent duplicate jobs)")
        self.info("   - Support smart retry with exponential backoff")
        self.info("   - Provide performance analytics")
